[
  {
    "title": "$:/plugins/felixhayashi/session-lock",
    "description": "TW5-SessionLock",
    "author": "Felix KÃ¼ppers",
    "version": "1.0.0+8",
    "released": "Sat, 18 Mar 2017 01:04:56 GMT",
    "core-version": ">=5.1.5",
    "source": "-",
    "type": "application/json",
    "plugin-type": "plugin",
    "list": "",
    "dependents": "",
    "text": "{\n    \"tiddlers\": {\n        \"$:/plugins/selock/tools/layout.css\": {\n            \"title\": \"$:/plugins/selock/tools/layout.css\",\n            \"type\": \"text/vnd.tiddlywiki\",\n            \"tags\": [\n                \"$:/tags/Stylesheet\"\n            ],\n            \"text\": \".selock-logout-button {\\n  display: inline-block;\\n}\\n\\n.selock-topbar {\\n  border: 1px solid lightgray;\\n  padding: 3px;\\n  background: #D1EED4;\\n  /* width: 200px; */\\n  text-shadow: initial;\\n  color: black;\\n  position: absolute;\\n  top: 0px;\\n  left: 0px;\\n  right: 0px;\\n  font-size: 14px;\\n}\\n\\n.selock-topbar.selock-write-mode {\\n   background: #EED5D1;\\n}\\n\\n@media (max-width: __breakpoint__) {\\n\\n .tc-sidebar-scrollable {\\n   padding-top: 60px;\\n }\\n\\n}\\n\"\n        },\n        \"$:/plugins/felixhayashi/session-lock/startup.js\": {\n            \"text\": \"'use strict';\\n\\n/*\\\\\\n\\ntitle: $:/plugins/felixhayashi/session-lock/startup.js\\ntype: application/javascript\\nmodule-type: startup\\n\\n@preserve\\n\\n\\\\*/\\n\\n/*** Code **********************************************************/\\n\\nvar handleStartSession = function handleStartSession() {\\n\\n  window.onbeforeunload = function () {\\n    return false;\\n  };\\n  $tw.rootWidget.dispatchEvent({ type: 'tm-browser-refresh' });\\n};\\n\\nvar handleEndSession = function handleEndSession() {\\n\\n  // remove any username\\n  $tm.utils.setField('$:/status/UserName', 'text', '');\\n  $tw.rootWidget.dispatchEvent({ type: 'tm-save-wiki' });\\n  $tw.rootWidget.dispatchEvent({ type: 'tm-browser-refresh' });\\n};\\n\\nvar lockSession = function lockSession(userName) {\\n\\n  if (!$tw.wiki.getTiddler(userName)) {\\n    $tw.wiki.addTiddler(new $tw.Tiddler({ title: userName, tags: ['User'] }, $tw.wiki.getCreationFields(), $tw.wiki.getModificationFields()));\\n  }\\n  // set current user\\n  $tm.utils.setField('$:/status/UserName', 'text', userName);\\n  // save wiki\\n  $tw.rootWidget.dispatchEvent({ type: 'tm-save-wiki' });\\n};\\n\\n/**\\n * Prevent the user from saving the wiki.\\n */\\nvar disableSaving = function disableSaving() {\\n\\n  $tw.rootWidget.addEventListener('tm-auto-save-wiki', function () {});\\n  $tw.rootWidget.addEventListener('tm-save-wiki', function () {});\\n  // remove any username\\n  $tm.utils.setField('$:/status/UserName', 'text', '');\\n  // hide buttons\\n  var tiddlersToBeHidden = ['$:/config/PageControlButtons/Visibility/$:/core/ui/Buttons/save-wiki', '$:/config/PageControlButtons/Visibility/$:/core/ui/Buttons/new-tiddler', '$:/config/PageControlButtons/Visibility/$:/core/ui/Buttons/save-wiki', '$:/config/PageControlButtons/Visibility/$:/core/ui/Buttons/control-panel', '$:/config/ViewToolbarButtons/Visibility/$:/core/ui/Buttons/edit', '$:/config/ViewToolbarButtons/Visibility/$:/core/ui/Buttons/more-tiddler-actions', '$:/config/ViewToolbarButtons/Visibility/$:/plugins/felixhayashi/tiddlymap/misc/quickConnectButton'];\\n\\n  tiddlersToBeHidden.forEach(function (tRef) {\\n    return $tm.utils.setField(tRef, 'text', 'hide');\\n  });\\n};\\n\\nvar listeners = {\\n  'selock:tm-start-session': handleStartSession,\\n  'selock:tm-end-session': handleEndSession\\n};\\n\\nvar startup = function startup() {\\n\\n  // add handlers to the root widget to make them available from everywhere\\n  $tm.utils.addTWlisteners(listeners, $tw.rootWidget, undefined);\\n\\n  var dialogParams = {\\n    dialog: {\\n      buttons: 'ok',\\n      preselects: { 'mode': 'read' }\\n    }\\n  };\\n\\n  $tm.dialogManager.open('initialDialog', dialogParams, function (isConfirmed, outputTObj) {\\n\\n    if (outputTObj) {\\n      var userName = $tm.utils.getField(outputTObj, 'user');\\n      if (userName) {\\n        lockSession(userName);\\n        return;\\n      }\\n    }\\n\\n    disableSaving();\\n  });\\n};\\n\\n/*** Exports *******************************************************/\\n\\nexports.name = 'sessionlock';\\nexports.platforms = ['browser'];\\nexports.after = ['story', 'tmap.caretaker'];\\nexports.synchronous = true;\\nexports.startup = startup;\\n//# sourceMappingURL=./maps/felixhayashi/session-lock/js/startup.js.map\\n\",\n            \"title\": \"$:/plugins/felixhayashi/session-lock/startup.js\",\n            \"type\": \"application/javascript\",\n            \"module-type\": \"startup\"\n        },\n        \"$:/plugins/felixhayashi/tiddlymap/dialog/initialDialog\": {\n            \"title\": \"$:/plugins/felixhayashi/tiddlymap/dialog/initialDialog\",\n            \"subtitle\": \"{{$:/core/images/info-button }} Session info\",\n            \"text\": \"\\\\define write-mode-active()\\n<div style=\\\"border: 1px solid lightgray; padding: 5px; background: #EED5D1;\\\">\\n  The wiki is currently edited by <b>{{$:/status/UserName}}</b>.\\n</div>\\n\\\\end\\n\\n\\\\define read-mode-active()\\n<div style=\\\"border: 1px solid lightgray; padding: 5px; background: #D1EED4;\\\">\\n  The wiki is currently not edited.\\n</div>\\n\\\\end\\n\\n\\\\define new-user-form()\\n//A user with this name does not exist and will be created.//\\n\\\\end\\n\\n<$list filter=\\\"[field:title[$:/status/UserName]has[text]]\\\" emptyMessage=\\\"<<read-mode-active>>\\\">\\n<<write-mode-active>>\\n</$list>\\n\\nBefore you can use this wiki you need to state whether you want to use this wiki in read or write mode.\\n\\n|!<$radio field=\\\"mode\\\" value=\\\"write\\\"></$radio> |!Write mode |You gain exclusive write access until you logout.|\\n|!<$radio field=\\\"mode\\\" value=\\\"read\\\"></$radio> |!Read mode |You will be able to open all wiki content but cannot change any content. In case you decide to edit the wiki after you opened it in read-only mode, you need to reload the wiki and select write-mode.|\\n\\n<$reveal type=\\\"nomatch\\\" text=\\\"read\\\" default={{!!mode}} animate=\\\"yes\\\">\\n\\n!! Please authenticate yourself to open the wiki in write-mode.\\n\\nSelect your name from the list below or add it.\\n\\n''Name'': <$edit-text tiddler=<<output>> field=\\\"user\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" />\\n\\n<$set name=\\\"user\\\" value={{!!user}}>\\n<ul style=\\\"padding-left: 60px\\\">\\n<$list filter=\\\"[tag[User]] +[search:title<user>]\\\" emptyMessage=<<new-user-form>>>\\n  <li>\\n    <$button class=\\\"tc-btn-invisible tmap-link\\\">\\n      <$view field=\\\"title\\\" />\\n      <$action-setfield $tiddler=<<output>> user={{!!title}} />\\n    </$button>\\n  </li>\\n</$list>\\n</ul>\\n</$set>\\n\\n</$reveal>\\n\"\n        },\n        \"$:/plugins/felixhayashi/tiddlymap/dialogFooter/ok\": {\n            \"title\": \"$:/plugins/felixhayashi/tiddlymap/dialogFooter/ok\",\n            \"text\": \"<$button>Ok\\n\\n  <!-- trigger dialog callback -->\\n  <$action-setfield $tiddler=<<result>> text=\\\"1\\\" />\\n\\n  <!-- close modal -->\\n  <$action-sendmessage $message=\\\"tm-close-tiddler\\\" />\\n\\n</$button>\\n\"\n        },\n        \"$:/plugins/felixhayashi/tiddlymap/dialogFooter/ok_cancel\": {\n            \"title\": \"$:/plugins/felixhayashi/tiddlymap/dialogFooter/ok_cancel\",\n            \"text\": \"<$transclude tiddler=\\\"$:/plugins/felixhayashi/tiddlymap/dialogFooter/ok\\\" mode=\\\"inline\\\" />\\n<$button>Cancel\\n  <!-- trigger dialog callback -->\\n  <$action-setfield $tiddler=<<result>> text=\\\"\\\" />\\n  <!-- close modal -->\\n  <$action-sendmessage $message=\\\"tm-close-tiddler\\\" />\\n</$button>\\n\"\n        },\n        \"$:/plugins/felixhayashi/tiddlymap/dialogFooter/ok_suppress\": {\n            \"title\": \"$:/plugins/felixhayashi/tiddlymap/dialogFooter/ok_suppress\",\n            \"text\": \"<$set name=\\\"currentTiddler\\\" value=<<title>> >\\n\\n<$checkbox field=\\\"suppress\\\" checked=\\\"1\\\" unchecked=\\\"0\\\" default=\\\"0\\\"> Do not show this dialog again</$checkbox>\\n<$button>Ok\\n\\n  <!-- trigger dialog callback -->\\n  <$action-setfield $tiddler=<<result>> text=\\\"1\\\" />\\n  \\n  <!-- close modal -->\\n  <$action-sendmessage $message=\\\"tm-close-tiddler\\\" />\\n  <$action-sendmessage $message=\\\"tmap:tm-suppress-dialog\\\"\\n                       dialog=<<templateId>>\\n                       suppress={{!!suppress}} />\\n                       \\n</$button>\\n\\n</$set>\"\n        },\n        \"$:/selock/tools/sessionInfo\": {\n            \"title\": \"$:/selock/tools/sessionInfo\",\n            \"tags\": \"$:/tags/PageTemplate\",\n            \"text\": \"\\\\define read-mode-active()\\n\\n<div class=\\\"selock-topbar\\\">\\nWiki running in ''read-only'' mode. Changes are not stored!\\n<$button class=\\\"selock-logout-button\\\">Edit wiki\\n  <$action-sendmessage $message=\\\"selock:tm-start-session\\\" />\\n</$button>\\n</div>\\n\\n\\\\end\\n\\n\\\\define write-mode-active()\\n\\n<div class=\\\"selock-topbar selock-write-mode\\\">\\nWiki is currently edited by <b>{{$:/status/UserName}}</b>!\\n<$button class=\\\"selock-logout-button\\\">Exit session\\n  <$action-sendmessage $message=\\\"selock:tm-end-session\\\" />\\n</$button>\\n</div>\\n\\n\\\\end\\n\\n<$list filter=\\\"[field:title[$:/status/UserName]has[text]]\\\" emptyMessage=\\\"<<read-mode-active>>\\\">\\n<<write-mode-active>>\\n</$list>\\n\"\n        }\n    }\n}"
  }
]